---
title: "Análise Multinível SAEB 2019"
author: "Tailine J. S. Nonato"
date: "2024-06-29"
format: pdf
---

# Modelagem Multinível

- Orientação: Prof. Dr. Luis Gustavo

1. Modelo Nulo

2. Adição de variáveis do primeiro nível (aluno)

3. Adição de variáveis do segundo nível (escola)

4. Adição de efeitos aleatórios do primeiro nível

5. Comparação entre modelos utilizando X²

6. Análise de resíduos

7. Definição do melhor modelo

# Pacotes e Funções	

```{r}
#| warning: false

if (!require(pacman)) install.packages("pacman")
pacman::p_load(vroom,tidyverse,lme4,stargazer, texreg) #stargazer is for latex output
#options(OutDec = ",")
setwd("C:/Users/User/Documents/GitHub/gradest-1/TCC/relatorio")
```

## Leitura dos dados
```{r}	
df <- vroom("dados_tcc.csv")%>%
  select(ID_ALUNO,ID_ESCOLA,PROFICIENCIA_MT_SAEB,PROFICIENCIA_LP_SAEB, NIVEL_SOCIO_ECONOMICO, NSEA, ID_AREA, ID_LOCALIZACAO, PC_FORMACAO_DOCENTE_FINAL, TX_RESP_Q002, TX_RESP_Q004, TX_RESP_Q011, TX_RESP_Q015, TX_RESP_Q016, TX_RESP_Q017A, TX_RESP_Q017B, TX_RESP_Q017C, TX_RESP_Q017D, TX_RESP_Q018A, TX_RESP_Q018B)

df_used <- df %>%
  filter(across(everything(), ~ !(. %in% c("*", ".")))) %>%
  na.omit(df_used)
```	

## Modelo nulo
```{r}
modelo_nulo <- lmer(PROFICIENCIA_LP_SAEB ~ 1 + (1|ID_ESCOLA), data = df_used)
summary(modelo_nulo)

stargazer(modelo_nulo, type = "latex")
```	

```{r}	
#modelo_nulo <- lme(fixed=PROFICIENCIA_LP_SAEB ~ 1, random=~1|ID_ESCOLA, data = df_sampled)

RandomEffects <- as.data.frame(VarCorr(modelo_nulo))
RandomEffects

ICC_between <- RandomEffects[1,4]/(RandomEffects[1,4]+RandomEffects[2,4]) 
ICC_between
```


## Modelo com adição de variáveis do primeiro nível

```{r}
modelo1 <- lmer(PROFICIENCIA_LP_SAEB ~ NSEA + TX_RESP_Q002 + TX_RESP_Q004 + TX_RESP_Q011 + TX_RESP_Q015 + TX_RESP_Q017A + TX_RESP_Q017C + TX_RESP_Q017D + TX_RESP_Q018A + TX_RESP_Q018B + (1|ID_ESCOLA), data = df_used)

stargazer(modelo1, type = "latex")

randomEffects <- as.data.frame(VarCorr(modelo1))
#randomEffects

ICC_between <- randomEffects[1,4]/(randomEffects[1,4]+randomEffects[2,4])
ICC_between
```

## Modelo com adição de variáveis do segundo nível

```{r}
modelo2 <- lmer(PROFICIENCIA_LP_SAEB ~ NSEA + TX_RESP_Q002 + TX_RESP_Q004 + TX_RESP_Q011 + TX_RESP_Q015 + TX_RESP_Q017A + TX_RESP_Q017C + TX_RESP_Q017D + TX_RESP_Q018A + TX_RESP_Q018B + NIVEL_SOCIO_ECONOMICO + ID_AREA +  ID_LOCALIZACAO + PC_FORMACAO_DOCENTE_FINAL + (1|ID_ESCOLA), data = df_used)

summary(modelo2)

stargazer(modelo2, type = "latex")

randomEffects <- as.data.frame(VarCorr(modelo2))
#randomEffects

ICC_between <- randomEffects[1,4]/(randomEffects[1,4]+randomEffects[2,4])
ICC_between
```

## Modelo com adição de efeitos aleatórios do primeiro nível

```{r}
modelo3 <- lmer(PROFICIENCIA_LP_SAEB ~ NSEA + TX_RESP_Q002 + TX_RESP_Q004 + TX_RESP_Q011 + TX_RESP_Q015 + TX_RESP_Q017A + TX_RESP_Q017B + TX_RESP_Q017C + TX_RESP_Q017D + TX_RESP_Q018A + TX_RESP_Q018B + (1 + NSEA|ID_ESCOLA), data = df_used)

system.time({
  modelo3 <- lmer(PROFICIENCIA_LP_SAEB ~ NSEA + TX_RESP_Q002 + TX_RESP_Q004 + TX_RESP_Q011 + TX_RESP_Q015 + TX_RESP_Q017A + TX_RESP_Q017B + TX_RESP_Q017C + TX_RESP_Q017D + TX_RESP_Q018A + TX_RESP_Q018B + (1 + NSEA|ID_ESCOLA), data = df_used)
})

summary(modelo3)
```

## Comparação entre modelos utilizando X²

```{r}
anova(modelo1, modelo2)
anova(modelo2, modelo3)
```

## Análise de resíduos

```{r}
residuos <- residuals(modelo2)
qqnorm(residuos)
qqline(residuos)
```