---
title: "Cecampe-CO/PDDE"
subtitle: "Entrega 1"
author: "Tailine J. S. Nonato"
format: pdf
---

# Objetivo

Organizar os dados para identificar as escolas que não participaram do PDDE 2023. Depois de algum tratamento estas escolas serão objeto de monitoramento (Por que não estão no programa? Como o CECAMPE CO – MONITORAMENTO pode ajudá-las a ingressar no programa?)

# Metodologia

A princípio, realizou-se a um processo de ETL, no qual os dados foram extraídos, transformados e carregados:

- Na etapa de extração, os microdados do Censo Escolar de 2022 foram obtidos do site do INEP, enquanto os dados do PDDE foram adquiridos por meio da utilização do Consulta Escola do FNDE. Para garantir a leitura correta dos dados do PDDE, os arquivos foram convertidos para o formato CSV. 

- Na etapa de transformação, os dados foram filtrados para selecionar apenas as escolas localizadas na região Centro-Oeste. Em seguida, os dados foram submetidos ao cruzamento de informações do Censo Escolar com o PDDE, utilizando o código da escola como chave.

- Ao manter todo o processo documentado e replicável, obteve-se uma base de dados completa a qual foi realizada a extração.

Os resultados apresentados a seguir foram obtidos após a remoção de duplicatas e a utilização das variáveis "NO_UF", "TP_DEPENDENCIA", "TP_SITUACAO_FUNCIONAMENTO", "TP_LOCALIZACAO_DIFERENCIADA" e "fonte", sendo esta última responsável por diferenciar as escolas pagas e não pagas.

# Resultados

```{r}
#| message: false
#| warning: false
#| echo: false
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, knitr, openxlsx, kableExtra)
```

```{r}
#| warning: false
#| message: false
#| echo: false

dados <- read.csv("dados/base_completa.csv")
dados <- dados %>% 
        select(CO_ENTIDADE, NO_UF, TP_DEPENDENCIA, TP_SITUACAO_FUNCIONAMENTO, TP_LOCALIZACAO_DIFERENCIADA, fonte) %>%
        distinct(CO_ENTIDADE, .keep_all = TRUE)
```

```{r}	
#| warning: false
#| message: false
#| echo: false
tab1 <- dados %>% 
        group_by(NO_UF, TP_DEPENDENCIA) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_DEPENDENCIA, n, fill = 0) %>% 
        mutate_at(vars(`1`, `2`, `3`, `4`), as.numeric) %>% 
        select(NO_UF, `1`, `2`, `3`, `4`) %>% 
        rename(`Federal` = `1`, `Estadual` = `2`, `Municipal` = `3`, `Privada` = `4`) %>%
        mutate(Total = rowSums(select(., -NO_UF))) %>%
        add_row(NO_UF = "Total", Federal = sum(.$Federal, na.rm = TRUE), 
                Estadual = sum(.$Estadual, na.rm = TRUE), 
                Municipal = sum(.$Municipal, na.rm = TRUE), 
                Privada = sum(.$Privada, na.rm = TRUE), 
                Total = sum(.$Total, na.rm = TRUE))

tab1 %>%
  kable(align = "l", 
        caption = "Número de escolas públicas segundo a dependência administrativa e a UF – Centro-Oeste") %>%
  footnote(general = "Censo Escolar 2022", general_title = "Fonte:")
```	


```{r}
#| warning: false
#| message: false
#| echo: false

tab2 <- dados %>% 
        group_by(NO_UF, TP_SITUACAO_FUNCIONAMENTO) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_SITUACAO_FUNCIONAMENTO, n, fill = 0) %>% 
        mutate_at(vars(matches("^[12345]$")), as.numeric) %>% 
        rename_at(vars(matches("^[12345]$")), 
                  ~c("Em atividade", "Paralisada", "Extinta", "Em atividade de educação especial", "Paralisada de educação especial")[match(., c("1", "2", "3", "4", "5"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))

tab2 %>%
  kable(align = "l", 
        caption = "Número de escolas públicas segundo a situação de funcionamento e a UF – Centro-Oeste") %>%
  footnote(general = "Censo Escolar 2022", general_title = "Fonte:")
```

```{r}
#| warning: false
#| message: false
#| echo: false
dados <- dados %>% 
  mutate(TP_LOCALIZACAO_DIFERENCIADA = ifelse(is.na(TP_LOCALIZACAO_DIFERENCIADA), "5", TP_LOCALIZACAO_DIFERENCIADA))

tab3 <- dados %>% 
        group_by(NO_UF, TP_LOCALIZACAO_DIFERENCIADA) %>%
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_LOCALIZACAO_DIFERENCIADA, n, fill = 0) %>% 
        mutate_at(vars(matches("^[012345]$")), as.numeric) %>% 
        rename_at(vars(matches("^[012345]$")), 
                  ~c("Não diferenciada", "Urbana", "Rural", "Rural de difícil acesso", "Indígena","NA")[match(., c("0","1", "2", "3", "4","5"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))

tab3 %>%
  kable(align = "l", 
        caption = "Número de escolas públicas segundo a localização e a UF – Centro-Oeste (identificação das escolas em localização diferenciada)") %>%
  footnote(general = "Censo Escolar 2022", general_title = "Fonte:")
```

```{r}	
#| warning: false
#| message: false
#| echo: false

tab4 <- dados %>% 
        filter(fonte == "pdde_pagos") %>% 
        group_by(NO_UF, TP_DEPENDENCIA) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_DEPENDENCIA, n, fill = 0) %>% 
        mutate_at(vars(matches("^[1234]$")), as.numeric) %>% 
        rename_at(vars(matches("^[1234]$")), 
                  ~c("Federal", "Estadual", "Municipal", "Privada")[match(., c("1", "2", "3", "4"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))

tab4 %>%
  kable(align = "l", 
        caption = "Número de escolas participantes do PDDE: Escolas PAGAS em 2023") %>%
  footnote(general = "Consulta Escola/FNDE; Censo Escolar 2022", general_title = "Fonte:")
```


```{r}	
#| warning: false
#| message: false
#| echo: false

tab5 <- dados %>% 
        filter(fonte == "pdde_naopagos") %>% 
        group_by(NO_UF, TP_DEPENDENCIA) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_DEPENDENCIA, n, fill = 0) %>% 
        mutate_at(vars(matches("^[1234]$")), as.numeric) %>% 
        rename_at(vars(matches("^[1234]$")), 
                  ~c("Federal", "Estadual", "Municipal", "Privada")[match(., c("1", "2", "3", "4"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))


tab5 %>%
  kable(align = "l", 
        caption = "Número de escolas participantes do PDDE: Escolas NÃO PAGAS em 2023") %>%
  footnote(general = "Consulta Escola/FNDE; Censo Escolar 2022", general_title = "Fonte:")
```

```{r}
#| warning: false
#| message: false
#| echo: false

tab6 <- dados %>% 
        filter(fonte %in% c("pdde_pagos","pdde_naopagos")) %>%
        group_by(NO_UF, TP_DEPENDENCIA) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_DEPENDENCIA, n, fill = 0) %>% 
        mutate_at(vars(matches("^[1234]$")), as.numeric) %>% 
        rename_at(vars(matches("^[1234]$")), 
                  ~c("Federal", "Estadual", "Municipal", "Privada")[match(., c("1", "2", "3", "4"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))


tab6 %>%
  kable(align = "l", 
        caption = "Número de escolas participantes do PDDE 2023") %>%
  footnote(general = "Consulta Escola/FNDE; Censo Escolar 2022", general_title = "Fonte:")
```

```{r}
#| warning: false
#| message: false
#| echo: false

tab7 <- dados %>% 
        filter(!fonte %in% c("pdde_pagos","pdde_naopagos")) %>% 
        group_by(NO_UF, TP_DEPENDENCIA) %>% 
        summarise(n = n(), .groups = 'drop') %>% 
        spread(TP_DEPENDENCIA, n, fill = 0) %>% 
        mutate_at(vars(matches("^[1234]$")), as.numeric) %>% 
        rename_at(vars(matches("^[1234]$")), 
                  ~c("Federal", "Estadual", "Municipal", "Privada")[match(., c("1", "2", "3", "4"))]) %>%
        mutate(Total = rowSums(select(., -NO_UF), na.rm = TRUE)) %>%
        add_row(NO_UF = "Total", !!!colSums(select(., -NO_UF), na.rm = TRUE))


tab7 %>%
  kable(align = "l", 
        caption = "Número de escolas não participantes do PDDE") %>%
  footnote(general = "Consulta Escola/FNDE; Censo Escolar 2022", general_title = "Fonte:")
```



```{r}
#| warning: false
#| message: false
#| echo: false


## Exportando as tabelas para um arquivo Excel
wb <- createWorkbook()
addWorksheet(wb, "tab1")
writeData(wb, "tab1", tab1)
addWorksheet(wb, "tab2")
writeData(wb, "tab2", tab2)
addWorksheet(wb, "tab3")
writeData(wb, "tab3", tab3)
addWorksheet(wb, "tab4")
writeData(wb, "tab4", tab4)
addWorksheet(wb, "tab5")
writeData(wb, "tab5", tab5)
addWorksheet(wb, "tab6")
writeData(wb, "tab6", tab6)
addWorksheet(wb, "tab7")
writeData(wb, "tab7", tab7)
saveWorkbook(wb, "relatorio2.xlsx", overwrite = TRUE)
```