---
title: "Centro Colaborador de Apoio ao Monitoramento e à Gestão de Programas Educacionais do Centro Oeste"
subtitle: "Monitoramento e Apoio às UEx do PDDE Básico e  PDDE Ações Integradas"
author: "Tailine J. S. Nonato"
format: pdf

---

# Entrega 4: Análise de Saldos e Repasses

## Repasses do PDDE Básico em 2023
```{r}
#| message: false
#| warning: false
#| echo: false
if (!require(pacman)) install.packages("pacman")
pacman::p_load(tidyverse, knitr, readxl, openxlsx, kableExtra)
#setwd("C:/Users/User/Documents/GitHub/gradest-1/PDDE/entrega 4")
setwd("/Users/tailine.nonato/Documents/gradest/PDDE/entrega 4")
```


```{r}
#| message: false
#| warning: false
#| echo: false

dados <- read_excel("situacao-atendimento-entidade.xlsx")

dados_esc <- dados %>%
  group_by(Cod_Escola, Quantidade) %>%
  summarise(ValorTotal = sum(ValorTotal), ValorCusteio = sum(ValorCusteio), ValorCapital = sum(ValorCapital))


kable(format(nrow(dados_esc), big.mark = "."), align='l', col.names = "Número de escolas")%>%
  kable_styling(full_width = F, position = "left")%>%
  footnote(general = "Consulta Escola/FNDE",
  general_title = "Fonte:")

```

### Tabela 1: Medidas de Tendência Central e Dispersão dos Repasses

```{r}
#| message: false
#| warning: false
#| echo: false

# Calculando a soma, média e desvio padrão
soma <- round(sum(dados_esc$ValorTotal),2)
media <- round(mean(dados_esc$ValorTotal),2)
desvio <- round(sd(dados_esc$ValorTotal),2)

soma_custeio <- round(sum(dados_esc$ValorCusteio),2)
media_custeio <- round(mean(dados_esc$ValorCusteio),2)
desvio_custeio <- round(sd(dados_esc$ValorCusteio),2)

soma_capital <- round(sum(dados_esc$ValorCapital),2)
media_capital <- round(mean(dados_esc$ValorCapital),2)
desvio_capital <- round(sd(dados_esc$ValorCapital),2)

soma_custeio_perc <- sum(dados_esc$ValorCusteio)/sum(dados_esc$ValorTotal)
soma_capital_perc <- sum(dados_esc$ValorCapital)/sum(dados_esc$ValorTotal)
media_custeio_perc <- mean(dados_esc$ValorCusteio)/mean(dados_esc$ValorTotal)

media_capital_perc <- mean(dados_esc$ValorCapital)/mean(dados_esc$ValorTotal)
desvio_custeio_perc <- sd(dados_esc$ValorCusteio)/sd(dados_esc$ValorTotal)
desvio_capital_perc <- sd(dados_esc$ValorCapital)/sd(dados_esc$ValorTotal)

estatisticas1 <- data.frame("Soma" = c(soma, soma_custeio, soma_custeio_perc, soma_capital, soma_capital_perc),
                           "Média" = c(media, media_custeio, media_custeio_perc, media_capital, media_capital_perc),
                           "Desvio Padrão" = c(desvio, desvio_custeio, desvio_custeio_perc, desvio_capital, desvio_capital_perc))

rownames(estatisticas1) <- c("Valor Total", "Valor Custeio", "Valor Custeio (%)", "Valor Capital", "Valor Capital (%)")

# -------------------------------------------

# Valor Total to R$
soma <- paste0("R$", format(soma, big.mark = ".", decimal.mark = ",",nsmall=2))
media <- paste0("R$", format(media, big.mark = ".", decimal.mark = ",",nsmall=2))
desvio <- paste0("R$", format(desvio, big.mark = ".", decimal.mark = ",",nsmall=2))

# Valor Custeio to R$
soma_custeio <- paste0("R$", format(soma_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))
media_custeio <- paste0("R$", format(media_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))
desvio_custeio <- paste0("R$", format(desvio_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))

# Valor Capital to R$
soma_capital <- paste0("R$", format(soma_capital, big.mark = ".", decimal.mark = ",",nsmall=2))
media_capital <- paste0("R$", format(media_capital, big.mark = ".", decimal.mark = ",",nsmall=2))
desvio_capital <- paste0("R$", format(desvio_capital, big.mark = ".", decimal.mark = ",",nsmall=2))

estatisticas <- data.frame("Soma" = c(soma, soma_custeio, soma_capital),
                           "Média" = c(media, media_custeio, media_capital),
                           "Desvio Padrão" = c(desvio, desvio_custeio,desvio_capital))

rownames(estatisticas) <- c("Valor Total", "Valor Custeio", "Valor Capital")
colnames(estatisticas) <- c("Soma", "Média", "Desvio Padrão")

kable(t(estatisticas), align = "l")%>%
  kable_styling(full_width = F, position = "left")%>%
  footnote(general = "Consulta Escola/FNDE",
  general_title = "Fonte:")

```

\vspace{2em}

### Tabela 2: Proporção na Alocação de Repasses Custeio e Capital

```{r}
#| message: false
#| warning: false
#| echo: false

# Custeio percentual 
soma_custeio_perc <- paste0(formatC(soma_custeio_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")
media_custeio_perc <- paste0(formatC(media_custeio_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")
desvio_custeio_perc <- paste0(formatC(desvio_custeio_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")

# Capital percentual to %
soma_capital_perc <- paste0(formatC(soma_capital_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")
media_capital_perc <- paste0(formatC(media_capital_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")
desvio_capital_perc <- paste0(formatC(desvio_capital_perc*100, format = "f", digits = 2, decimal.mark = ","), "%")

perc_valor <- data.frame("Alocação" = c(soma_custeio_perc, soma_capital_perc))

rownames(perc_valor) <- c("Valor Custeio (%)", "Valor Capital (%)")
colnames(perc_valor) <- c("Alocação")

kable(t(perc_valor), align = "l")%>%
  kable_styling(full_width = F, position = "left")%>%
  footnote(general = "Consulta Escola/FNDE",
  general_title = "Fonte:")

```	


### Tabela 3: Medidas Resumo dos Repasses por Categoria

```{r}
#| message: false
#| warning: false
#| echo: false

# Calculando o mínimo
minimo_total <- min(dados_esc$ValorTotal)
minimo_custeio <- min(dados_esc$ValorCusteio)
minimo_capital <- min(dados_esc$ValorCapital)

# Calculando os percentis
percentis_total <- quantile(dados_esc$ValorTotal, c(0.1, 0.25, 0.5, 0.75, 0.9))
percentis_custeio <- quantile(dados_esc$ValorCusteio, c(0.1, 0.25, 0.5, 0.75, 0.9))
percentis_capital <- quantile(dados_esc$ValorCapital, c(0.1, 0.25, 0.5, 0.75, 0.9))

# Calculando o máximo
maximo_total <- max(dados_esc$ValorTotal)
maximo_custeio <- max(dados_esc$ValorCusteio)
maximo_capital <- max(dados_esc$ValorCapital)

# Criando a tabela para excel
percentis1 <- data.frame("min" = c(minimo_total, minimo_custeio, minimo_capital),
                        "p10" = c(percentis_total[1], percentis_custeio[1], percentis_capital[1]),
                        "p25" = c(percentis_total[2], percentis_custeio[2], percentis_capital[2]),
                        "p50" = c(percentis_total[3], percentis_custeio[3], percentis_capital[3]),
                        "p75" = c(percentis_total[4], percentis_custeio[4], percentis_capital[4]),
                        "p90" = c(percentis_total[5], percentis_custeio[5], percentis_capital[5]),
                        "max" = c(maximo_total, maximo_custeio, maximo_capital))

rownames(percentis1) <- c("Valor Total", "Valor Custeio", "Valor Capital")
colnames(percentis1) <- c("Mínimo", "Percentil 10", "1º Quartil", "Mediana", "3º Quartil", "Percentil 90", "Máximo")


# ------------------------------------

# Formatando para R$
percentis_total <- paste0("R$", format(percentis_total, big.mark = ".", decimal.mark = ",",nsmall=2))
percentis_custeio <- paste0("R$", format(percentis_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))
percentis_capital <- paste0("R$", format(percentis_capital, big.mark = ".", decimal.mark = ",",nsmall=2))

# Formatando para R$
minimo_total <- paste0("R$", format(minimo_total, big.mark = ".", decimal.mark = ",",nsmall=2))
minimo_custeio <- paste0("R$", format(minimo_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))
minimo_capital <- paste0("R$", format(minimo_capital, big.mark = ".", decimal.mark = ",",nsmall=2))

# Formatando para R$
maximo_total <- paste0("R$", format(maximo_total, big.mark = ".", decimal.mark = ",",nsmall=2))
maximo_custeio <- paste0("R$", format(maximo_custeio, big.mark = ".", decimal.mark = ",",nsmall=2))
maximo_capital <- paste0("R$", format(maximo_capital, big.mark = ".", decimal.mark = ",",nsmall=2))

# Criando a tabela
percentis <- data.frame("min" = c(minimo_total, minimo_custeio, minimo_capital),
                        "p10" = c(percentis_total[1], percentis_custeio[1], percentis_capital[1]),
                        "p25" = c(percentis_total[2], percentis_custeio[2], percentis_capital[2]),
                        "p50" = c(percentis_total[3], percentis_custeio[3], percentis_capital[3]),
                        "p75" = c(percentis_total[4], percentis_custeio[4], percentis_capital[4]),
                        "p90" = c(percentis_total[5], percentis_custeio[5], percentis_capital[5]),
                        "max" = c(maximo_total, maximo_custeio, maximo_capital))

rownames(percentis) <- c("Valor Total", "Valor Custeio", "Valor Capital")
colnames(percentis) <- c("Mínimo", "Percentil 10", "1º Quartil", "Mediana", "3º Quartil", "Percentil 90", "Máximo")

percentis <- as.data.frame(t(percentis))
kable(percentis, align='l')%>%
  kable_styling(full_width = F, position = "left")%>%
  footnote(general = "Consulta Escola/FNDE",
  general_title = "Fonte:")

```



### Tabela 4: Frequência de Escolas por Faixa de Repasse (Valor Total)

```{r}
#| message: false
#| warning: false
#| echo: false

# Criando a tabela
dados_esc$faixa <- cut(dados_esc$ValorTotal, breaks = c(0, 500, 1000, 5000, 10000, 20000, 35000, 50000, 80000, Inf), labels = c("Até R$500", "R$501 a R$1000", "R$1001 a R$5000", "R$5001 a R$10000", "R$10001 a R$20000", "R$20001 a R$35000", "R$35001 a R$50000", "R$50001 a R$80000","Mais de R$80000"))

# Tabela de frequencia
tabela_freq <- table(dados_esc$faixa)
tabela_freq <- data.frame("Faixa" = names(tabela_freq), "Frequência" = as.numeric(tabela_freq))

# Ordenando a tabela
tabela_freq <- tabela_freq %>%
  mutate(Faixa = factor(Faixa, levels = c("Até R$500", "R$501 a R$1000", "R$1001 a R$5000", "R$5001 a R$10000", "R$10001 a R$20000", "R$20001 a R$35000", "R$35001 a R$50000", "R$50001 a R$80000","Mais de R$80000")))

# Adicionando a coluna de percentual
tabela_freq <- tabela_freq %>%
  mutate(Percentual = paste0(round(Frequência/sum(Frequência)*100, 2),"%"))

# Convert Faixa back to character
tabela_freq$Faixa <- as.character(tabela_freq$Faixa)

# Add the "Total" row
tabela_freq <- rbind(tabela_freq, c("Total", sum(tabela_freq$Frequência), "100%"))

# footnote

kable(tabela_freq, align = "l") %>%
  kable_styling(full_width = F, position = "left") %>%
  row_spec((nrow(tabela_freq)-1), extra_latex_after = "\\hline") %>%
  row_spec(nrow(tabela_freq), bold = TRUE) %>%
  footnote(general = "Consulta Escola/FNDE", general_title = "Fonte:")

```

```{r}	
#| message: false
#| warning: false
#| echo: false


# Exportando todas as tabelas para um arquivo .xlsx

wb <- createWorkbook()
addWorksheet(wb, "Tabela 1")
writeData(wb, "Tabela 1", estatisticas1)
addWorksheet(wb, "Tabela 2")
writeData(wb, "Tabela 2", perc_valor)
addWorksheet(wb, "Tabela 3")
writeData(wb, "Tabela 3", percentis1)
addWorksheet(wb, "Tabela 4")
writeData(wb, "Tabela 4", tabela_freq)
saveWorkbook(wb, "e4_tabelas_tailine_repasses.xlsx", overwrite = TRUE)
```